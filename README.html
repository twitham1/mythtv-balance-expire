<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title></title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<body>



<ul id="index">
  <li><a href="#NAME">NAME</a></li>
  <li><a href="#SYNOPSIS">SYNOPSIS</a></li>
  <li><a href="#DESCRIPTION">DESCRIPTION</a>
    <ul>
      <li><a href="#Usage-and-output">Usage and output</a></li>
    </ul>
  </li>
  <li><a href="#OPTIONS">OPTIONS</a></li>
  <li><a href="#CAVEATS">CAVEATS</a></li>
  <li><a href="#AUTHOR">AUTHOR</a></li>
  <li><a href="#COPYRIGHT-AND-LICENSE">COPYRIGHT AND LICENSE</a></li>
</ul>

<h1 id="NAME">NAME</h1>

<p>mythtv-balance-expire - move recording files to balance multiple disks</p>

<h1 id="SYNOPSIS">SYNOPSIS</h1>

<pre><code> mythtv-balance-expire [--help | --man | options]
    --help      show full usage of options and exit
    --man       show the full manual page and exit
    --size      balance by file size rather than file count
    --delta=N   expiring count delta allowed between disks [5]
    --titles    append titles to all files, not just moving files
    --subtitles append subtitles to titles
    --verbose   show the commands that would be run, or are being run:
    --go        actually do the moves, else just show what would be done</code></pre>

<h1 id="DESCRIPTION">DESCRIPTION</h1>

<p><b>mythtv-balance-expire</b> trades recording files between multiple local disks in a mythtv server to better balance the files over recorded time. Why would you want to do this you ask?</p>

<p>Say you have 6 months of recordings but your disk is full so you add another. The new disk now gets most new recordings since it has more free space. 6 months later both are full and recording new shows. But the original disk is now expiring files from 1 year ago while the new disk is expiring files only 6 months old. Mythtv&#39;s auto-expire list implies your are losing 1 year old recordings but this is misleading since the new disk must expire shows much younger.</p>

<p>Or, say you have a small disk and a large one, both full and recording via auto-expire. And you disable auto-expire on shows you really want to see someday to make sure you don&#39;t lose them to auto-expire. If you save a significant amount of shows this way, you can eventually have the small drive nearly full of saved files. So the auto-expire to record a new show is from just a few days ago, even if the large disk is expiring shows over a year old!</p>

<p>So, what you really need is for all disks to hold a similar amount of oldest expiring files. <b>This does that</b> by moving recordings among the disks.</p>

<h2 id="Usage-and-output">Usage and output</h2>

<p>Run with no arguments. This will take no actions and just show the expiring recordings and recommended moves.</p>

<p>The output shows expiring recordings in time sorted order. Counts are indented per disk, so each count &quot;column&quot; is a different disk. The lines look like:</p>

<pre><code>        SUM DELTA GB CHAN_YYYYMMDDHHMMSS.mpg /path/to/recording</code></pre>

<dl>

<dt id="SUM"><b>SUM</b></dt>
<dd>

<p>Number of expiring files or <b>--size</b> so far on this recording path, before placing the current file. Each path is indented to a unique column.</p>

</dd>
<dt id="DELTA"><b>DELTA</b></dt>
<dd>

<p>Current delta of the path with the most expiring content compared to the path with the least. When this value exceeds <b>--delta</b>, a move is triggered.</p>

</dd>
<dt id="GB"><b>GB</b></dt>
<dd>

<p>Size in gigabytes of this expiring file.</p>

</dd>
<dt id="CHAN_YYYYMMDDHHMMSS.mpg"><b>CHAN_YYYYMMDDHHMMSS.mpg</b></dt>
<dd>

<p>Recording file name: channel, time stamp and file extension. The lines are sorted by the YYYYMMDDHHMMSS time stamp of the recording.</p>

</dd>
<dt id="path-to-recording"><b>/path/to/recording</b></dt>
<dd>

<p>Current path to the recording file. The <b>--title</b> of the file is optionally shown.</p>

</dd>
</dl>

<p>Suggested moves are shown when a file should move to produce a better balance. These lines look like this:</p>

<pre><code>        &lt; GB expirefile /too/many/path -&gt; /too/few/path XXX free &lt; title
        &gt; GB keeperfile /too/few/path -&gt; /too/many/path YYY free &gt; title</code></pre>

<p>The expiring file is delimited by &lt; and shown with its size in gigabytes. It should move from the left path with too many to the right path with too few as shown by the arrow. The resulting file count and free space of the destination location is shown. Finally the title (and optionally <b>--subtitle</b>) of the moving file is displayed.</p>

<p>If the destination is now more full than the source, a trade is made. A file with auto-expire disabled (a permanent &quot;keeper&quot; file) is preferred. This keeper file is delimited by &gt;. It is selected by size that would result in closest headroom on the disks. If no keepers are left, then a future expiring file is used for trade instead. When balancing to a disk with more free space, no trade is needed.</p>

<p>A footer is provided which shows the end state of each disk. A notice is given if nothing has actually happened yet, see <b>--go</b>.</p>

<p>If the suggested moves look correct, you can add <b>--verbose</b> to see the commands that will be run. For the successful copies, the original location will be removed. If this still looks good, simply add <b>--go</b> to actually do the given file moves. When using <b>--go</b> you must be root or the owner of the recording directories (mythtv) so that you have permission to move the files.</p>

<h1 id="OPTIONS">OPTIONS</h1>

<dl>

<dt id="size"><b>--size</b></dt>
<dd>

<p>Balance by expiring file size rather than file count. This may become the default in the future if it proves to work better than file count.</p>

</dd>
<dt id="delta-N"><b>--delta N</b></dt>
<dd>

<p>Require each disk&#39;s expiring file count or size over time to be within N of all other disks. If a disk has &gt; N more than another, this triggers a file move to maintain this delta &lt;= N. Lower values produce a better balance while higher values need less moves. You can manipulate this value to see how many moves will be required and how they will affect disk headroom, before deciding to use <b>--go</b>. A high value like 9999 will simply show the current [im]balance with no moves. When used with <b>--size</b>, the units are gigabytes, otherwise the units are file counts. The default delta is 5.</p>

</dd>
<dt id="titles"><b>--titles</b></dt>
<dd>

<p>Show titles of all recording files. Without this option, titles are shown only for files that are moving.</p>

</dd>
<dt id="subtitles"><b>--subtitles</b></dt>
<dd>

<p>Append subtitles to all titles.</p>

</dd>
<dt id="verbose"><b>--verbose</b></dt>
<dd>

<p>Show the commands that will be run, or are being run with <b>--go</b>. If STDOUT is a terminal, then rsync(1) will use its <b>--progress</b> option to show copy progress, even without this <b>--verbose</b>.</p>

</dd>
<dt id="go"><b>--go</b></dt>
<dd>

<p>Actually do the file moves with rsync(1), removing the original only if successful. This requires write permission to the local recording directories so you must be root or mythtv on the server. If this option is not given, then no actions are taken.</p>

</dd>
</dl>

<h1 id="CAVEATS">CAVEATS</h1>

<p>You must have ~/.mythtv/config.xml configured to read your database and must be root or mythtv on the server for write permission to move the files. As shown in <b>--verbose</b>, rsync(1) is required.</p>

<p>This only works with local files and may be confused by multiple backends or remote paths. Patches welcome if you have such a setup.</p>

<p>Of course moving dozens of files will take a long time, so be patient when using <b>--go</b>. The initial <b>--go</b> will need to move more files than later runs. Rsync(1) --progress is shown on the terminal.</p>

<p>This does not update the database at all. Mythtv will automatically discover the new locations of the recordings. Allow time for this to happen between <b>--go</b> runs.</p>

<p>If your disks are different sizes, it may not be possible to balance recent time. This is normal - you will balance that time later when you run this again in the future. In fact, it is a good idea to run this periodically; I do so once a month. If you really trust the actions, you might crontab(1) this with redirection to a log file.</p>

<h1 id="AUTHOR">AUTHOR</h1>

<p>Timothy D Witham &lt;twitham@sbcglobal.net&gt;</p>

<h1 id="COPYRIGHT-AND-LICENSE">COPYRIGHT AND LICENSE</h1>

<p>Copyright 2017-2018 Timothy D Witham.</p>

<p>This program is free software; you can redistribute it and/or modify it under the same terms as Perl itself.</p>


</body>

</html>


